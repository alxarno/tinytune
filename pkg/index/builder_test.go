package index

import (
	"context"
	"encoding/base64"
	"os"
	"path/filepath"
	"strings"
	"testing"

	"github.com/stretchr/testify/require"
)

func TestIndexBuilder(t *testing.T) {
	t.Parallel()

	require := require.New(t)
	indexFile, err := os.Open("../../test/test.index.tinytune")
	require.NoError(err)
	index, err := NewIndex(context.Background(), indexFile)
	require.NoError(err)
	require.Len(index.meta, 17)
	sample, ok := index.meta["005f6b0265"]
	require.True(ok)
	require.True(sample.IsVideo())
	require.Equal("sample_960x400_ocean_with_audio.flv", sample.Name)
	require.Equal(960, sample.Resolution.Width)
	require.Equal(400, sample.Resolution.Height)
	require.EqualValues(37038, sample.Preview.Length)
	require.EqualValues(87368, sample.Preview.Offset)
	require.EqualValues(7222114, sample.OriginSize)
	require.LessOrEqual(sample.Preview.Offset+sample.Preview.Length, uint32(len(index.data)))
}

func TestIndexBuilderClearRemovedFiles(t *testing.T) {
	t.Parallel()

	testFolderPath, _ := strings.CutSuffix(os.Getenv("PWD"), "pkg/index")
	testFolderPath = filepath.Join(testFolderPath, "test")

	require := require.New(t)
	indexFile, err := os.Open("../../test/test.index.tinytune")
	require.NoError(err)

	filesPaths := []string{
		// removed item
		// "sample_minions.gif",
		"test.m3u8",
		"sample.txt",
		"2.ts",
		"video/sample_960x400_ocean_with_audio.flv",
		"image.jpg",
		"img/nested/nested-image.jpg",
		"img",
		"video/sample.mp4",
		"video",
		"Anh_nude_cover.webp",
		"test.index.tinytune",
		"img/nested",
		"long-name-sample-for-testing-names-displaying-1111122223333.txt",
		"img/image.jpg",
		"short.mp4",
		"sample.mp4",
	}

	filesMeta := []FileMeta{}

	for _, path := range filesPaths {
		path = filepath.Join(testFolderPath, path)
		stat, err := os.Stat(path)
		require.NoError(err)
		relativePath, err := filepath.Rel(testFolderPath, path)
		require.NoError(err)

		file := &mockFile{
			FileInfo:     stat,
			path:         path,
			relativePath: relativePath,
			dir:          stat.IsDir(),
			modTime:      stat.ModTime(),
		}
		filesMeta = append(filesMeta, file)
	}

	index, err := NewIndex(
		context.Background(),
		indexFile,
		WithFiles(filesMeta),
		WithRemovedFilesCleaning(),
	)
	require.NoError(err)
	require.Len(index.meta, len(filesPaths))

	dataPartLength := 483054
	removedPreviewLength := 15322
	// image.jpg file has 66002 (offset) 8620 (length)
	// will test preview
	itemNextRemoved := "024eb2ebdb"

	//nolint:lll
	itemNextPreviewData := "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"
	preview, err := index.PullPreview(ID(itemNextRemoved))
	require.NoError(err)
	require.Equal(base64.StdEncoding.EncodeToString(preview), itemNextPreviewData)
	require.Len(index.data, dataPartLength-removedPreviewLength)
}
